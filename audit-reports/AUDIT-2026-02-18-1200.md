# Full Audit Report

**Date:** 2026-02-18
**File(s):** Full project (`src/`, `convex/`)
**Project:** DocVault ‚Äî Document management with version control & team collaboration
**Stack:** Next.js 16 (App Router), Convex, Clerk, Resend, shadcn/ui

---

## Executive Summary

| Role | üî¥ High | üü° Medium | üîµ Low | Status |
|------|---------|-----------|--------|--------|
| Principal Engineer | 1 | 4 | 2 | ‚ö†Ô∏è |
| Security | 2 | 3 | 2 | üö® |
| DevOps | 1 | 4 | 2 | ‚ö†Ô∏è |
| Accessibility | 1 | 1 | 6 | ‚ö†Ô∏è |
| Patterns & DRY | 0 | 3 | 5 | ‚ö†Ô∏è |

---

## üèóÔ∏è Principal Engineer Findings

### üî¥ High

#### PE-H1: Race condition in version numbering
- **File:** `convex/documentVersions.ts:32-42`
- **Issue:** `createVersion` calculates the next version number by collecting all existing versions and finding the max. If two users upload concurrently, both read the same max and produce the same version number.
- **Fix:** Use a Convex mutex pattern or store a `nextVersion` counter on the document record and atomically increment it.

### üü° Medium

#### PE-M1: Unsafe `as any` type cast
- **File:** `src/app/teams/[teamId]/settings/page.tsx:115`
- **Issue:** `members as any` bypasses TypeScript entirely. The `MemberManager` component has a well-defined `Member[]` interface, so this cast hides potential type mismatches.
- **Fix:** Ensure the query return type aligns with `Member[]` or use a proper type assertion.

#### PE-M2: Unchecked route param ‚Üí Convex ID casts
- **Files:** `src/app/teams/[teamId]/page.tsx:33`, `src/app/documents/[documentId]/page.tsx:28`, and 4+ other locations
- **Issue:** Route params arrive as plain strings and are cast to `Id<"teams">` / `Id<"documents">` without validation. If a user navigates to `/teams/not-a-valid-id`, the cast silently passes a bad value to Convex, producing an unhelpful error.
- **Fix:** Validate or catch errors on the query side, or create a shared `useValidatedParam` hook.

#### PE-M3: N+1 query patterns in backend
- **Files:** `convex/documents.ts:39-57`, `convex/teams.ts:49-55`, `convex/documentVersions.ts:81-86`
- **Issue:** List queries loop over each record and issue individual `ctx.db.get()` or sub-queries per item. While Convex handles this better than traditional DBs, it still increases read bandwidth and latency.
- **Fix:** Consider denormalizing creator names onto documents, or batching lookups.

#### PE-M4: `deleteUser` leaves orphaned team memberships
- **File:** `convex/users.ts:114-126`
- **Issue:** When a user is deleted via webhook, only the `users` record is removed. Their `teamMembers` records persist as orphans, potentially causing null reference errors when other queries try to look up the user.
- **Fix:** Query and delete all `teamMembers` rows for this user, and consider cascading to documents they created.

### üîµ Low

#### PE-L1: Hardcoded dark theme
- **File:** `src/app/layout.tsx:30`
- **Issue:** `className="dark"` is hardcoded on `<html>`. The app uses `next-themes` as a dependency but doesn't wire up theme switching.
- **Fix:** Use `<ThemeProvider>` from next-themes and allow user preference.

#### PE-L2: No error boundaries
- **Issue:** Pages render loading skeletons but lack React error boundaries. If a Convex query throws, the entire page crashes with no recovery path.
- **Fix:** Add error boundaries at the layout or page level.

---

## üîí Security Findings

### üî¥ High

#### SEC-H1: XSS in email HTML template
- **File:** `convex/email.ts:33-55`
- **Issue:** User-controlled values (`args.invitedByName`, `args.teamName`, `args.role`) are interpolated directly into an HTML string without escaping. An attacker could create a team named `<script>alert(1)</script>` and inject arbitrary HTML/JS into invite emails.
- **Fix:** HTML-escape all interpolated values before inserting into the template, or use a templating library with auto-escaping.

#### SEC-H2: Missing auth on `getDownloadUrl`
- **File:** `convex/documentVersions.ts:90-95`
- **Issue:** This query accepts any `storageId` and returns a download URL without verifying the caller's identity or team membership. Any authenticated user (or potentially unauthenticated if the query is public) can download any file if they know the storage ID.
- **Fix:** Look up the `documentVersion` by `storageId`, find the parent document, and verify team membership before returning the URL.

### üü° Medium

#### SEC-M1: No file size limit enforcement
- **Files:** `convex/documentVersions.ts:5-11` (generateUploadUrl), `src/app/teams/[teamId]/page.tsx:79`, `src/components/upload-dialog.tsx:72`
- **Issue:** Neither frontend nor backend enforces a maximum file size. A malicious user could upload arbitrarily large files, consuming storage and incurring costs.
- **Fix:** Validate `fileSize` in `createVersion` and reject files above a configurable limit. Add client-side validation too.

#### SEC-M2: No file type validation
- **Files:** Same upload paths as SEC-M1
- **Issue:** The app accepts any file type. There's no allowlist/denylist for file types. Executable files, scripts, or other dangerous types can be uploaded.
- **Fix:** Validate `fileType` against an allowlist in `createVersion`.

#### SEC-M3: Missing input length validation
- **Files:** `convex/teams.ts:11` (team name), `convex/documents.ts:10` (doc name), `convex/documentVersions.ts:49` (comment)
- **Issue:** String inputs (team name, document name, version comment) have no length limits. A user could submit megabytes of text as a team name.
- **Fix:** Add `v.string()` length validation in Convex arg validators, or validate in the handler.

### üîµ Low

#### SEC-L1: Backend trusts client-supplied `storageId`
- **File:** `convex/documentVersions.ts:14-61`
- **Issue:** `createVersion` accepts a `storageId` from the client. While Convex storage IDs are opaque, a malicious client could reference a storage object they didn't upload.
- **Fix:** Consider having the backend verify storage ownership or using a server-side upload flow.

#### SEC-L2: Non-null assertion on env var
- **File:** `src/components/providers.tsx:11`
- **Issue:** `process.env.NEXT_PUBLIC_CONVEX_URL!` uses a non-null assertion. If the env var is missing at build/runtime, it produces a confusing error rather than a clear failure message.
- **Fix:** Add a runtime check and throw a descriptive error.

---

## ‚öôÔ∏è DevOps Findings

### üî¥ High

#### OPS-H1: No env var validation at startup
- **File:** `convex/auth.config.ts:4`
- **Issue:** `process.env.CLERK_JWT_ISSUER_DOMAIN` is used without validation. If undefined, authentication silently breaks with cryptic errors. Similarly, `CLERK_WEBHOOK_SECRET` in `http.ts` will throw at runtime but only when a webhook arrives.
- **Fix:** Validate all required env vars at startup/deploy time and fail fast with clear messages.

### üü° Medium

#### OPS-M1: Unhandled Resend API errors
- **File:** `convex/email.ts:29`
- **Issue:** `resend.emails.send()` can throw network errors, rate limit errors, or API errors. None are caught, so any failure will surface as an unhandled action error.
- **Fix:** Wrap in try/catch with structured logging and consider retry logic.

#### OPS-M2: No timeouts on file upload fetch
- **Files:** `src/app/teams/[teamId]/page.tsx:79-83`, `src/components/upload-dialog.tsx:72-76`
- **Issue:** `fetch()` calls for file upload have no `AbortController` or timeout. Large files on slow connections could hang indefinitely with the UI stuck in "Uploading..." state.
- **Fix:** Add an `AbortController` with a reasonable timeout and show progress indication.

#### OPS-M3: No rate limiting on mutations
- **Files:** `convex/teams.ts:10` (create), `convex/teams.ts:93` (addMember)
- **Issue:** No rate limiting on team creation or invite sending. A malicious user could create thousands of teams or spam invites.
- **Fix:** Implement rate limiting using a Convex rate limiter pattern.

#### OPS-M4: Localhost fallback in email links
- **File:** `convex/email.ts:25`
- **Issue:** `APP_URL` falls back to `http://localhost:3000`. If the env var is not set in production, all invite email links will point to localhost ‚Äî broken for recipients.
- **Fix:** Make `APP_URL` a required env var with validation, or throw if not set in production.

### üîµ Low

#### OPS-L1: Unstructured console logging
- **Files:** `src/components/providers.tsx:23`, `convex/email.ts:18`, `convex/http.ts:46`
- **Issue:** Errors are logged with `console.error`/`console.warn` without structured metadata. Hard to search, filter, or alert on in production.
- **Fix:** Use structured logging with context (user ID, team ID, action name).

#### OPS-L2: No health check endpoint
- **Issue:** No way to verify the app is running and connected to Convex. Load balancers and monitoring tools have nothing to ping.
- **Fix:** Add a `/api/health` Next.js route handler that verifies Convex connectivity.

---

## ‚ôø Accessibility Findings

### üî¥ High

#### A11Y-H1: Missing `aria-label` on icon-only buttons (WCAG 4.1.2)
- **Files (all affected):**
  - `src/app/documents/[documentId]/page.tsx:56` ‚Äî Back arrow button
  - `src/app/teams/[teamId]/page.tsx:151-155` ‚Äî Back arrow button
  - `src/app/teams/[teamId]/page.tsx:294-298` ‚Äî Settings gear button
  - `src/app/teams/[teamId]/settings/page.tsx:92` ‚Äî Back arrow button
  - `src/components/document-table.tsx:187-190` ‚Äî More actions (‚ãØ) button
  - `src/components/upload-dialog.tsx:165-173` ‚Äî Remove file (X) button
  - `src/components/member-manager.tsx:261-269` ‚Äî Remove member button
  - `src/components/member-manager.tsx:324-329` ‚Äî Cancel invite button
- **Issue:** Buttons that contain only an icon (no visible text) have no `aria-label` or `aria-labelledby`. Screen readers announce them as "button" with no description of their purpose.
- **Fix:** Add `aria-label` to each icon-only button (e.g., `aria-label="Go back"`, `aria-label="Team settings"`, `aria-label="More actions"`, `aria-label="Remove file"`, `aria-label="Remove member"`, `aria-label="Cancel invite"`).

### üü° Medium

#### A11Y-M1: No skip navigation link (WCAG 2.4.1)
- **File:** `src/app/layout.tsx`
- **Issue:** There is no skip-to-content link for keyboard users. Users must tab through the entire navbar before reaching page content.
- **Fix:** Add a visually-hidden skip link as the first child of `<body>` that focuses `<main>`.

### üîµ Low

#### A11Y-L1: Missing table captions
- **Files:** `src/components/document-table.tsx:139`, `src/components/member-manager.tsx:180`
- **Issue:** Data tables lack `<caption>` elements, making it harder for screen readers to announce the table's purpose.

#### A11Y-L2: File upload drop zones lack descriptive ARIA
- **Files:** `src/app/teams/[teamId]/page.tsx:232-244`, `src/components/upload-dialog.tsx:176-188`
- **Issue:** The file upload button areas don't have an `aria-label` that clearly describes file selection.

#### A11Y-L3: Color-only role differentiation
- **File:** `src/components/role-badge.tsx`
- **Issue:** Role badges differentiate roles primarily through color variants. Users with color vision deficiency may have trouble distinguishing them.

#### A11Y-L4: Native `confirm()` dialogs
- **Files:** `src/components/document-table.tsx:103`, `src/app/teams/[teamId]/settings/page.tsx:68`
- **Issue:** Native `confirm()` has limited accessibility. Custom confirmation dialogs using AlertDialog would provide better keyboard navigation and screen reader support.

#### A11Y-L5: Missing focus management verification
- **Issue:** Multiple dialogs are used (rename, upload, create document). Focus return behavior should be verified with screen readers.

#### A11Y-L6: `autoFocus` may disorient screen reader users
- **Files:** `src/app/teams/new/page.tsx:78`, `src/components/document-table.tsx:240`
- **Issue:** `autoFocus` can be unexpected for screen reader users who may miss context before the focused element.

---

## üîÑ Patterns & DRY Findings

### üü° Medium

#### DRY-M1: Duplicate `formatFileSize` function
- **Files:** `src/components/document-table.tsx:64-70`, `src/components/version-history.tsx:38-44`
- **Issue:** Identical function copy-pasted in two components.
- **Fix:** Extract to `src/lib/utils.ts` and import from both.

#### DRY-M2: Duplicate file upload flow
- **Files:** `src/app/teams/[teamId]/page.tsx:77-98`, `src/components/upload-dialog.tsx:67-101`
- **Issue:** The `generateUploadUrl ‚Üí fetch POST ‚Üí parse storageId ‚Üí createVersion` pattern is duplicated. Both also duplicate the file picker UI.
- **Fix:** Extract a `useFileUpload` custom hook and reuse `UploadDialog` in the team page instead of reimplementing.

#### DRY-M3: Duplicate invite auto-accept logic
- **File:** `convex/users.ts:38-54` and `convex/users.ts:90-108`
- **Issue:** The pending invite acceptance loop is duplicated between `ensureUser` and `getOrCreateUser`.
- **Fix:** Extract to a shared `acceptPendingInvites(ctx, userId, email)` helper.

### üîµ Low

#### DRY-L1: Repeated loading skeleton pattern
- **Files:** Dashboard, team page, settings, document page, version history
- **Issue:** The same `[...Array(3)].map((_, i) => <div className="... animate-pulse" />)` appears in 5+ places.
- **Fix:** Create a `<SkeletonList count={3} />` component.

#### DRY-L2: Repeated `as Id<"...">` casting
- **Files:** All page components using route params
- **Issue:** `teamId as Id<"teams">`, `documentId as Id<"documents">` casting pattern repeated everywhere.
- **Fix:** Create a typed `useConvexParam<T>(paramName)` hook.

#### DRY-L3: Scattered `Role` type definition
- **Files:** `convex/lib/permissions.ts:4`, `src/components/document-table.tsx:40`, `src/components/member-manager.tsx:34`
- **Issue:** The `Role` type is independently defined in 3 places.
- **Fix:** Export from a single shared location and import everywhere.

#### DRY-L4: Repeated toast error handler pattern
- **Files:** Nearly every async handler in all page/component files
- **Issue:** `catch(error) { toast.error(error instanceof Error ? error.message : "...") }` is duplicated 10+ times.
- **Fix:** Create a `handleError(error, fallback)` utility or a `useAsyncAction` hook.

#### DRY-L5: Repeated team existence checks in backend
- **Files:** `convex/teams.ts` (multiple functions)
- **Issue:** Several mutations independently fetch and null-check the team record.
- **Fix:** Extract a `getTeamOrThrow(ctx, teamId)` helper.

---

## Recommended Action Order

1. **SEC-H1** ‚Äî Escape HTML in email template (quick fix, high impact)
2. **SEC-H2** ‚Äî Add auth check to `getDownloadUrl` (quick fix, critical access control gap)
3. **PE-H1** ‚Äî Fix version numbering race condition (use atomic counter on document)
4. **OPS-H1** ‚Äî Add env var validation for `CLERK_JWT_ISSUER_DOMAIN` and other required vars
5. **A11Y-H1** ‚Äî Add `aria-label` to all icon-only buttons (straightforward, many locations)
6. **SEC-M1** ‚Äî Add file size limits (backend validation + client-side check)
7. **SEC-M3** ‚Äî Add input length validation on team/document names
8. **PE-M4** ‚Äî Clean up team memberships on user deletion
9. **DRY-M1** ‚Äî Extract `formatFileSize` to shared utils
10. **DRY-M2** ‚Äî Consolidate file upload flow into reusable hook
11. **DRY-M3** ‚Äî Extract invite acceptance logic to shared helper
12. **OPS-M4** ‚Äî Make `APP_URL` required in production
13. **A11Y-M1** ‚Äî Add skip navigation link
14. **PE-M1** ‚Äî Remove `as any` cast in team settings page

## Files Requiring Immediate Attention

- `convex/email.ts` ‚Äî [Security, DevOps]: XSS in HTML template, unhandled API errors, localhost fallback
- `convex/documentVersions.ts` ‚Äî [Security, Principal]: Missing auth on download, race condition in versioning
- `convex/users.ts` ‚Äî [Principal, DRY]: Orphaned memberships on delete, duplicate invite logic
- `convex/auth.config.ts` ‚Äî [DevOps]: No env var validation
- `src/components/document-table.tsx` ‚Äî [A11Y, DRY]: Missing aria-labels, duplicate formatFileSize
- `src/components/upload-dialog.tsx` ‚Äî [A11Y, DRY, DevOps]: Missing aria-labels, duplicate upload flow, no timeout
- `src/components/member-manager.tsx` ‚Äî [A11Y]: Multiple icon-only buttons without labels
- `src/app/teams/[teamId]/page.tsx` ‚Äî [DRY, DevOps]: Duplicate upload flow, no upload timeout
- `src/app/teams/[teamId]/settings/page.tsx` ‚Äî [Principal]: `as any` type cast
